name: 🔁 Update Profile README

on:
  schedule:
    - cron: '0 * * * *'  # every hour
  workflow_dispatch:
  repository_dispatch:

jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
      - name: ⬇️ Checkout code
        uses: actions/checkout@v4

      - name: 🧠 Fetch public repos
        uses: actions/github-script@v7
        id: generate
        with:
          script: |
            const user = 'rajatrv-ciso';
            const { data: repos } = await github.rest.repos.listForUser({
              username: user,
              per_page: 100,
              sort: "updated"
            });
            const featured = repos
              .filter(r => !r.fork && !r.private)
              .map(r => `- [**${r.name}**](${r.html_url})  \n  ${r.description || 'No description'}`)
              .slice(0, 5)
              .join('\n\n');
            return `<!-- REPO_LIST_START -->\n${featured}\n<!-- REPO_LIST_END -->`;

      - name: 🛠️ Update README
        run: |
          CONTENT=$(echo "${{ steps.generate.outputs.result }}" | sed 's/"/\"/g')
          awk -v r="$CONTENT" '
            BEGIN {start=0}
            /<!-- REPO_LIST_START -->/ {print; print r; start=1; next}
            /<!-- REPO_LIST_END -->/ {start=0}
            !start
          ' README.md > new_README.md
          mv new_README.md README.md

      - name: 📤 Commit and push changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "🔄 Auto-update featured repositories"
